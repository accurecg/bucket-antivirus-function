{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "SSMParameters",
            "Effect": "Allow",
            "Action": [
                "ssm:GetParameter",
                "ssm:GetParameters"
            ],
            "Resource": [
                "arn:aws:ssm:*:*:parameter/aav.*",
                "arn:aws:ssm:*:*:parameter/aab.*"
            ]
        },
        {
            "Sid": "ECR",
            "Effect": "Allow",
            "Action": [
                "ecr:GetAuthorizationToken"
            ],
            "Resource": "*"
        },
        {
            "Sid": "ECRRepository",
            "Effect": "Allow",
            "Action": [
                "ecr:CreateRepository",
                "ecr:DescribeRepositories",
                "ecr:DescribeImages",
                "ecr:InitiateLayerUpload",
                "ecr:UploadLayerPart",
                "ecr:CompleteLayerUpload",
                "ecr:PutImage",
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
                "ecr:BatchGetImage"
            ],
            "Resource": "arn:aws:ecr:*:*:repository/*"
        },
        {
            "Sid": "S3SamArtifacts",
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:DeleteObject"
            ],
            "Resource": [
                "arn:aws:s3:::YOUR_SAM_BUCKET",
                "arn:aws:s3:::YOUR_SAM_BUCKET/*"
            ]
        },
        {
            "Sid": "CloudFormation",
            "Effect": "Allow",
            "Action": [
                "cloudformation:CreateStack",
                "cloudformation:UpdateStack",
                "cloudformation:DeleteStack",
                "cloudformation:DescribeStacks",
                "cloudformation:DescribeStackEvents",
                "cloudformation:DescribeStackResources",
                "cloudformation:GetTemplate",
                "cloudformation:GetTemplateSummary",
                "cloudformation:ValidateTemplate",
                "cloudformation:CreateChangeSet",
                "cloudformation:ExecuteChangeSet",
                "cloudformation:DeleteChangeSet",
                "cloudformation:DescribeChangeSet"
            ],
            "Resource": "*"
        },
        {
            "Sid": "IAMPassRole",
            "Effect": "Allow",
            "Action": "iam:PassRole",
            "Resource": [
                "arn:aws:iam::*:role/av-ecs-execution-*",
                "arn:aws:iam::*:role/av-ecs-task-*",
                "arn:aws:iam::*:role/bucket-antivirus-lambdas*",
                "arn:aws:iam::*:role/av-update-schedule-*"
            ],
            "Condition": {
                "StringEquals": {
                    "iam:PassedToService": [
                        "ecs-tasks.amazonaws.com",
                        "lambda.amazonaws.com"
                    ]
                }
            }
        },
        {
            "Sid": "IAMPassRoleSAM",
            "Effect": "Allow",
            "Action": "iam:PassRole",
            "Resource": "arn:aws:iam::*:role/bucket-antivirus-lambdas*"
        },
        {
            "Sid": "IAMCreateRoles",
            "Effect": "Allow",
            "Action": [
                "iam:CreateRole",
                "iam:DeleteRole",
                "iam:GetRole",
                "iam:PutRolePolicy",
                "iam:DeleteRolePolicy",
                "iam:AttachRolePolicy",
                "iam:DetachRolePolicy",
                "iam:TagRole",
                "iam:UntagRole",
                "iam:ListRoleTags"
            ],
            "Resource": [
                "arn:aws:iam::*:role/av-ecs-execution-*",
                "arn:aws:iam::*:role/av-ecs-task-*",
                "arn:aws:iam::*:role/bucket-antivirus-lambdas*",
                "arn:aws:iam::*:role/av-update-schedule-*"
            ]
        },
        {
            "Sid": "SQSScoped",
            "Effect": "Allow",
            "Action": [
                "sqs:CreateQueue",
                "sqs:GetQueueUrl",
                "sqs:GetQueueAttributes",
                "sqs:SetQueueAttributes",
                "sqs:DeleteQueue",
                "sqs:TagQueue",
                "sqs:UntagQueue",
                "sqs:ListQueueTags"
            ],
            "Resource": "arn:aws:sqs:*:*:av-scan-queue-*"
        },
        {
            "Sid": "S3DefinitionsBucketScoped",
            "Effect": "Allow",
            "Action": [
                "s3:CreateBucket",
                "s3:PutBucketPolicy",
                "s3:PutBucketPublicAccessBlock",
                "s3:DeleteBucket",
                "s3:PutBucketTagging",
                "s3:GetBucketTagging"
            ],
            "Resource": "arn:aws:s3:::av-definitions-*"
        },
        {
            "Sid": "LambdaScoped",
            "Effect": "Allow",
            "Action": [
                "lambda:CreateFunction",
                "lambda:DeleteFunction",
                "lambda:GetFunction",
                "lambda:UpdateFunctionCode",
                "lambda:UpdateFunctionConfiguration",
                "lambda:AddPermission",
                "lambda:RemovePermission",
                "lambda:TagResource",
                "lambda:UntagResource",
                "lambda:ListTags"
            ],
            "Resource": [
                "arn:aws:lambda:*:*:function:av-enqueue-*"
            ]
        },
        {
            "Sid": "EventsScoped",
            "Effect": "Allow",
            "Action": [
                "events:PutRule",
                "events:DeleteRule",
                "events:PutTargets",
                "events:RemoveTargets",
                "events:DescribeRule",
                "events:TagResource",
                "events:UntagResource",
                "events:ListTagsForResource"
            ],
            "Resource": "arn:aws:events:*:*:rule/av-*"
        },
        {
            "Sid": "LogsScoped",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:DeleteLogGroup",
                "logs:PutRetentionPolicy",
                "logs:CreateLogStream",
                "logs:PutLogEvents",
                "logs:TagResource",
                "logs:UntagResource",
                "logs:ListTagsForResource"
            ],
            "Resource": [
                "arn:aws:logs:*:*:log-group:/ecs/bucket-antivirus-worker-*",
                "arn:aws:logs:*:*:log-group:/ecs/bucket-antivirus-update-*"
            ]
        },
        {
            "Sid": "ECSScoped",
            "Effect": "Allow",
            "Action": [
                "ecs:CreateCluster",
                "ecs:DeleteCluster",
                "ecs:DescribeClusters",
                "ecs:RegisterTaskDefinition",
                "ecs:DeregisterTaskDefinition",
                "ecs:CreateService",
                "ecs:DeleteService",
                "ecs:UpdateService",
                "ecs:DescribeServices",
                "ecs:DescribeTaskDefinition",
                "ecs:TagResource",
                "ecs:UntagResource",
                "ecs:ListTagsForResource"
            ],
            "Resource": [
                "arn:aws:ecs:*:*:cluster/bucket-antivirus-cluster-*",
                "arn:aws:ecs:*:*:task-definition/bucket-antivirus-worker-*:*",
                "arn:aws:ecs:*:*:service/bucket-antivirus-cluster-*/bucket-antivirus-worker-*",
                "arn:aws:ecs:*:*:task-definition/bucket-antivirus-update-*:*"
            ]
        },
        {
            "Sid": "EC2SecurityGroups",
            "Effect": "Allow",
            "Action": [
                "ec2:CreateSecurityGroup",
                "ec2:DeleteSecurityGroup",
                "ec2:DescribeSecurityGroups",
                "ec2:AuthorizeSecurityGroupEgress",
                "ec2:RevokeSecurityGroupEgress",
                "ec2:CreateTags",
                "ec2:DeleteTags"
            ],
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "ec2:Region": "us-east-1"
                }
            }
        }
    ]
}